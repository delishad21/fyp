# -----------------------------------------------------------------------------
# Local dev proxy used in docker-compose.dev.yml.
# Routes /api/* to internal microservices for local testing.
# -----------------------------------------------------------------------------
server {
  listen 8085;
  client_max_body_size 120m;

  location = /api/user {
    # Normalize trailing slash.
    return 301 /api/user/;
  }
  location = /api/quiz {
    # Normalize trailing slash.
    return 301 /api/quiz/;
  }
  location = /api/class {
    # Normalize trailing slash.
    return 301 /api/class/;
  }
  location = /api/ai {
    # Normalize trailing slash.
    return 301 /api/ai/;
  }

  location /api/user/ {
    # User service
    proxy_pass http://user-service:7301/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location /api/quiz/ {
    # Quiz service
    proxy_pass http://quiz-service:7302/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location /api/class/ {
    # Class service
    proxy_pass http://class-service:7303/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location /api/ai/ {
    # AI service
    proxy_pass http://ai-service:7304/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
