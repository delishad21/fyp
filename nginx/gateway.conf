# -----------------------------------------------------------------------------
#   Gateway used in docker-compose.test.yml. for local hosting.
#   Exposes a single entrypoint on port 8085 and routes:
#     /            -> web-app
#     /api/user    -> user-service
#     /api/quiz    -> quiz-service
#     /api/class   -> class-service
#     /phone-app   -> phone-web (static Expo web build)
# -----------------------------------------------------------------------------
server {
  listen 8085;

  location = /api/user {
    # Normalize trailing slash.
    return 301 /api/user/;
  }
  location = /api/quiz {
    # Normalize trailing slash.
    return 301 /api/quiz/;
  }
  location = /api/class {
    # Normalize trailing slash.
    return 301 /api/class/;
  }

  location /api/user/ {
    # User service
    proxy_pass http://user-service:7301/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location /api/quiz/ {
    # Quiz service
    proxy_pass http://quiz-service:7302/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location /api/class/ {
    # Class service
    proxy_pass http://class-service:7303/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location / {
    # Web app (Next.js)
    proxy_pass http://web-app:3000/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
