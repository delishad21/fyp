services:
  redis:
    image: redis:7-alpine
    command: >
      redis-server --appendonly yes --save 60 1000
      --requirepass ${REDIS_PASSWORD:-supersecret_please_change}
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-supersecret_please_change}
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-supersecret_please_change}", "ping"]
      interval: 5s
      timeout: 2s

  redpanda:
    image: redpandadata/redpanda:latest
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp=1
      - --memory=512M
      - --reserve-memory=0M
      - --node-id=0
      - --check=false
      - --advertise-kafka-addr=PLAINTEXT://redpanda:9092,OUTSIDE://localhost:9094
      - --kafka-addr=PLAINTEXT://0.0.0.0:9092,OUTSIDE://0.0.0.0:9094
      - --advertise-rpc-addr=redpanda:33145
      - --rpc-addr=0.0.0.0:33145
    ports:
      - "9092:9092"
      - "9094:9094"
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD", "bash", "-c", "rpk cluster health | grep -qE 'Healthy|Degraded'"]
      interval: 10s
      timeout: 5s

  console:
    image: docker.redpanda.com/redpandadata/console:latest
    depends_on: [redpanda]
    environment:
      - KAFKA_BROKERS=redpanda:9092
    ports:
      - "8080:8080"

  dev-proxy:
    image: nginx:1.27-alpine
    ports:
      - "8085:8085"
    volumes:
      - ./nginx/dev-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on: [user-service, quiz-service, class-service]

  mongo-class:
    image: mongo:7
    container_name: mongodb-class
    command: ["--replSet","rs0","--keyFile","/etc/mongo-keyfile","--bind_ip_all","--auth"]
    ports:
      - "27017:27017"
    volumes:
      - ./mongo/mongo-class-data:/data/db
      - ./mongo/mongo-secrets/mongo-keyfile:/etc/mongo-keyfile:ro
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-rootpassword}

  mongo-user:
    image: mongo:7
    container_name: mongodb-user
    command: ["--replSet","rs0","--keyFile","/etc/mongo-keyfile","--bind_ip_all","--auth"]
    ports:
      - "27018:27017"
    volumes:
      - ./mongo/mongo-user-data:/data/db
      - ./mongo/mongo-secrets/mongo-keyfile:/etc/mongo-keyfile:ro
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-rootpassword}

  mongo-quiz:
    image: mongo:7
    container_name: mongodb-quiz
    command: ["--replSet","rs0","--keyFile","/etc/mongo-keyfile","--bind_ip_all","--auth"]
    ports:
      - "27019:27017"
    volumes:
      - ./mongo/mongo-quiz-data:/data/db
      - ./mongo/mongo-secrets/mongo-keyfile:/etc/mongo-keyfile:ro
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-rootpassword}

  mongo-init-class:
    image: mongo:7
    depends_on: [mongo-class]
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "until mongosh --host mongo-class:27017 -u ${MONGO_ROOT_USERNAME:-root} -p ${MONGO_ROOT_PASSWORD:-rootpassword} --authenticationDatabase admin --eval 'db.adminCommand({ ping: 1 })' >/dev/null 2>&1; do sleep 2; done;
      mongosh --host mongo-class:27017 -u ${MONGO_ROOT_USERNAME:-root} -p ${MONGO_ROOT_PASSWORD:-rootpassword} --authenticationDatabase admin --eval 'rs.initiate({_id: \"rs0\", members: [{ _id: 0, host: \"mongo-class:27017\" }]})' || true"

  mongo-init-user:
    image: mongo:7
    depends_on: [mongo-user]
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "until mongosh --host mongo-user:27017 -u ${MONGO_ROOT_USERNAME:-root} -p ${MONGO_ROOT_PASSWORD:-rootpassword} --authenticationDatabase admin --eval 'db.adminCommand({ ping: 1 })' >/dev/null 2>&1; do sleep 2; done;
      mongosh --host mongo-user:27017 -u ${MONGO_ROOT_USERNAME:-root} -p ${MONGO_ROOT_PASSWORD:-rootpassword} --authenticationDatabase admin --eval 'rs.initiate({_id: \"rs0\", members: [{ _id: 0, host: \"mongo-user:27017\" }]})' || true"

  mongo-init-quiz:
    image: mongo:7
    depends_on: [mongo-quiz]
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "until mongosh --host mongo-quiz:27017 -u ${MONGO_ROOT_USERNAME:-root} -p ${MONGO_ROOT_PASSWORD:-rootpassword} --authenticationDatabase admin --eval 'db.adminCommand({ ping: 1 })' >/dev/null 2>&1; do sleep 2; done;
      mongosh --host mongo-quiz:27017 -u ${MONGO_ROOT_USERNAME:-root} -p ${MONGO_ROOT_PASSWORD:-rootpassword} --authenticationDatabase admin --eval 'rs.initiate({_id: \"rs0\", members: [{ _id: 0, host: \"mongo-quiz:27017\" }]})' || true"

  class-service:
    build:
      context: ./services/class-service
      target: dev
    command: npm run dev
    env_file:
      - .env
    environment:
      CLASS_PORT: ${CLASS_PORT:-7303}
      CLASS_MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME:-root}:${MONGO_ROOT_PASSWORD:-rootpassword}@mongo-class:27017/class?replicaSet=rs0&authSource=admin&retryWrites=true&w=majority
      USER_SVC_URL: http://user-service:7301
      QUIZ_SVC_URL: http://quiz-service:7302
      ENV: ${ENV:-PROD}
      IMAGE_UPLOAD_URL: ${CLASS_IMAGE_UPLOAD_URL}
      QUIZ_WEBHOOK_SECRET: ${QUIZ_WEBHOOK_SECRET}
      OUTBOX_PUBLISH_INTERVAL_MS: ${OUTBOX_PUBLISH_INTERVAL_MS}
      OUTBOX_BATCH_SIZE: ${OUTBOX_BATCH_SIZE}
      KAFKA_CLIENT_ID: ${CLASS_KAFKA_CLIENT_ID:-class-service}
      KAFKA_BROKERS: redpanda:9092
      KAFKA_GROUP: ${CLASS_KAFKA_GROUP:-class-svc.v1}
    ports:
      - "7303:7303"
    volumes:
      - ./services/class-service:/app
      - /app/node_modules
    depends_on: [mongo-class, redpanda]

  quiz-service:
    build:
      context: ./services/quiz-service
      target: dev
    command: npm run dev
    env_file:
      - .env
    environment:
      QUIZ_PORT: ${QUIZ_PORT:-7302}
      QUIZ_MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME:-root}:${MONGO_ROOT_PASSWORD:-rootpassword}@mongo-quiz:27017/quiz?replicaSet=rs0&authSource=admin&retryWrites=true&w=majority
      USER_SVC_URL: http://user-service:7301
      CLASS_SVC_URL: http://class-service:7303
      ENV: ${ENV:-PROD}
      IMAGE_UPLOAD_URL: ${QUIZ_IMAGE_UPLOAD_URL}
      QUIZ_WEBHOOK_SECRET: ${QUIZ_WEBHOOK_SECRET}
      OUTBOX_PUBLISH_INTERVAL_MS: ${OUTBOX_PUBLISH_INTERVAL_MS}
      OUTBOX_BATCH_SIZE: ${OUTBOX_BATCH_SIZE}
      KAFKA_CLIENT_ID: ${QUIZ_KAFKA_CLIENT_ID:-quiz-service}
      KAFKA_BROKERS: redpanda:9092
      KAFKA_GROUP: ${QUIZ_KAFKA_GROUP:-quiz-svc.v1}
      ATTEMPT_REDIS_URL: redis://default:${REDIS_PASSWORD:-supersecret_please_change}@redis:6379/0
    ports:
      - "7302:7302"
    volumes:
      - ./services/quiz-service:/app
      - /app/node_modules
    depends_on: [mongo-quiz, redpanda, redis]

  user-service:
    build:
      context: ./services/user-service
      target: dev
    command: npm run dev
    env_file:
      - .env
    environment:
      USER_PORT: ${USER_PORT:-7301}
      USER_MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME:-root}:${MONGO_ROOT_PASSWORD:-rootpassword}@mongo-user:27017/user?replicaSet=rs0&authSource=admin&retryWrites=true&w=majority
      ENV: ${ENV:-PROD}
      JWT_SECRET: ${JWT_SECRET:-dev-secret}
      GMAIL_USER: ${GMAIL_USER}
      GMAIL_PASS: ${GMAIL_PASS}
      GMAIL_NAME: ${GMAIL_NAME}
      APP_NAME: ${APP_NAME}
      FRONTEND_URL: ${FRONTEND_URL}
    ports:
      - "7301:7301"
    volumes:
      - ./services/user-service:/app
      - /app/node_modules
    depends_on: [mongo-user]

  web-app:
    build:
      context: ./web-app
      target: dev
    env_file:
      - .env
    environment:
      JWT_SECRET: ${JWT_SECRET:-dev-secret}
      USER_SVC_URL: ${NEXT_USER_URL}
      QUIZ_SVC_URL: ${NEXT_QUIZ_URL}
      CLASS_SVC_URL: ${NEXT_CLASS_URL}
    ports:
      - "3000:3000"
    volumes:
      - ./web-app:/app
      - /app/node_modules
    depends_on: [user-service]
    extra_hosts:
      - "api.local:host-gateway"

  phone-app:
    build:
      context: ./phone-app
    command: npm run start -- --host lan --port 8081
    env_file:
      - .env
    stdin_open: true
    tty: true
    ports:
      - "8081:8081"
      - "19000:19000"
      - "19001:19001"
      - "19002:19002"
    volumes:
      - ./phone-app:/app
      - /app/node_modules

  phone-frame-dev:
    image: nginx:1.27-alpine
    ports:
      - "8090:8090"
    volumes:
      - ./phone-app/frame/phone-frame-dev.html:/usr/share/nginx/html/phone-frame-dev.html:ro
      - ./phone-app/frame/nginx.dev.conf:/etc/nginx/conf.d/default.conf:ro
    extra_hosts:
      - "api.local:host-gateway"
    depends_on: [phone-app]

volumes:
  redis-data:
  redpanda-data:
