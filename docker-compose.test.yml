# -----------------------------------------------------------------------------
#   Deployment-ready compose stack for local hosting.
#   Runs all services locally (web, microservices, mongo/redis/redpanda, phone frame + phone web app)
#   and exposes only the public-facing ports needed by nginx.
#
#   Note: Build and push service images to registry before using this file.
#
# Usage:
#   1) Copy existing root `.env` into same folder as this file.
#   2) Start the stack:
#        docker compose -f docker-compose.test.yml up -d
#   3) Point host nginx to http://127.0.0.1:8085 (the gateway container).
#
# Notes:
#   - The nginx container in this stack routes services as follows:
#       /            -> web-app (port 3000)
#       /api/user    -> user-service (port 7301)
#       /api/quiz    -> quiz-service (port 7302)
#       /api/class   -> class-service (port 7303)
#       /api/ai      -> ai-service (port 7304)
#       /phone-app   -> phone-frame (port 8080)
#       /phone-web   -> phone-web-app (port 8080)
#   - Uploads are persisted via named volumes:
#       class-uploads, quiz-uploads, ai-uploads
# -----------------------------------------------------------------------------
services:
  redis:
    image: redis:7-alpine
    command: >
      redis-server --appendonly yes --save 60 1000
      --requirepass ${REDIS_PASSWORD:-supersecret_please_change}
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-supersecret_please_change}
    volumes:
      - /srv/quizapp/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-supersecret_please_change}", "ping"]
      interval: 5s
      timeout: 2s

  redpanda:
    image: redpandadata/redpanda:latest
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp=1
      - --memory=512M
      - --reserve-memory=0M
      - --node-id=0
      - --check=false
      - --advertise-kafka-addr=PLAINTEXT://redpanda:9092,OUTSIDE://localhost:9094
      - --kafka-addr=PLAINTEXT://0.0.0.0:9092,OUTSIDE://0.0.0.0:9094
      - --advertise-rpc-addr=redpanda:33145
      - --rpc-addr=0.0.0.0:33145
    volumes:
      - /srv/quizapp/redpanda:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD", "bash", "-c", "rpk cluster health | grep -qE 'Healthy|Degraded'"]
      interval: 10s
      timeout: 5s

  gateway:
    image: nginx:1.27-alpine
    ports:
      - "8085:8085"
    volumes:
      - /srv/quizapp/nginx/gateway.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on: [web-app, user-service, quiz-service, class-service, ai-service, phone-frame, phone-web-app]

  mongo-class:
    image: mongo:7
    container_name: mongodb-class
    command: ["--replSet","rs0","--keyFile","/etc/mongo-keyfile","--bind_ip_all","--auth"]
    ports:
      - "27017:27017"
    volumes:
      - /srv/quizapp/mongo/mongo-class-data:/data/db
      - /srv/quizapp/mongo/mongo-secrets/mongo-keyfile:/etc/mongo-keyfile:ro
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-rootpassword}

  mongo-user:
    image: mongo:7
    container_name: mongodb-user
    command: ["--replSet","rs0","--keyFile","/etc/mongo-keyfile","--bind_ip_all","--auth"]
    ports:
      - "27018:27017"
    volumes:
      - /srv/quizapp/mongo/mongo-user-data:/data/db
      - /srv/quizapp/mongo/mongo-secrets/mongo-keyfile:/etc/mongo-keyfile:ro
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-rootpassword}

  mongo-quiz:
    image: mongo:7
    container_name: mongodb-quiz
    command: ["--replSet","rs0","--keyFile","/etc/mongo-keyfile","--bind_ip_all","--auth"]
    ports:
      - "27019:27017"
    volumes:
      - /srv/quizapp/mongo/mongo-quiz-data:/data/db
      - /srv/quizapp/mongo/mongo-secrets/mongo-keyfile:/etc/mongo-keyfile:ro
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-rootpassword}


  mongo-ai:
    image: mongo:7
    container_name: mongodb-ai
    command: ["--replSet","rs0","--keyFile","/etc/mongo-keyfile","--bind_ip_all","--auth"]
    ports:
      - "27020:27017"
    volumes:
      - /srv/quizapp/mongo/mongo-ai-data:/data/db
      - /srv/quizapp/mongo/mongo-secrets/mongo-keyfile:/etc/mongo-keyfile:ro
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-rootpassword}
  mongo-init-class:
    image: mongo:7
    depends_on: [mongo-class]
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "until mongosh --host mongo-class:27017 -u ${MONGO_ROOT_USERNAME:-root} -p ${MONGO_ROOT_PASSWORD:-rootpassword} --authenticationDatabase admin --eval 'db.adminCommand({ ping: 1 })' >/dev/null 2>&1; do sleep 2; done;
      mongosh --host mongo-class:27017 -u ${MONGO_ROOT_USERNAME:-root} -p ${MONGO_ROOT_PASSWORD:-rootpassword} --authenticationDatabase admin --eval 'rs.initiate({_id: \"rs0\", members: [{ _id: 0, host: \"mongo-class:27017\" }]})' || true"

  mongo-init-user:
    image: mongo:7
    depends_on: [mongo-user]
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "until mongosh --host mongo-user:27017 -u ${MONGO_ROOT_USERNAME:-root} -p ${MONGO_ROOT_PASSWORD:-rootpassword} --authenticationDatabase admin --eval 'db.adminCommand({ ping: 1 })' >/dev/null 2>&1; do sleep 2; done;
      mongosh --host mongo-user:27017 -u ${MONGO_ROOT_USERNAME:-root} -p ${MONGO_ROOT_PASSWORD:-rootpassword} --authenticationDatabase admin --eval 'rs.initiate({_id: \"rs0\", members: [{ _id: 0, host: \"mongo-user:27017\" }]})' || true"

  mongo-init-quiz:
    image: mongo:7
    depends_on: [mongo-quiz]
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "until mongosh --host mongo-quiz:27017 -u ${MONGO_ROOT_USERNAME:-root} -p ${MONGO_ROOT_PASSWORD:-rootpassword} --authenticationDatabase admin --eval 'db.adminCommand({ ping: 1 })' >/dev/null 2>&1; do sleep 2; done;
      mongosh --host mongo-quiz:27017 -u ${MONGO_ROOT_USERNAME:-root} -p ${MONGO_ROOT_PASSWORD:-rootpassword} --authenticationDatabase admin --eval 'rs.initiate({_id: \"rs0\", members: [{ _id: 0, host: \"mongo-quiz:27017\" }]})' || true"


  mongo-init-ai:
    image: mongo:7
    depends_on: [mongo-ai]
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "until mongosh --host mongo-ai:27017 -u ${MONGO_ROOT_USERNAME:-root} -p ${MONGO_ROOT_PASSWORD:-rootpassword} --authenticationDatabase admin --eval 'db.adminCommand({ ping: 1 })' >/dev/null 2>&1; do sleep 2; done;
      mongosh --host mongo-ai:27017 -u ${MONGO_ROOT_USERNAME:-root} -p ${MONGO_ROOT_PASSWORD:-rootpassword} --authenticationDatabase admin --eval 'rs.initiate({_id: "rs0", members: [{ _id: 0, host: "mongo-ai:27017" }]})' || true"
  class-service:
    image: ${REGISTRY:-delishad21}/class-service:${IMAGE_TAG:-latest}
    environment:
      NODE_ENV: production
      CLASS_PORT: ${CLASS_PORT:-7303}
      CLASS_MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME:-root}:${MONGO_ROOT_PASSWORD:-rootpassword}@mongo-class:27017/class?replicaSet=rs0&authSource=admin&retryWrites=true&w=majority
      USER_SVC_URL: http://user-service:7301
      QUIZ_SVC_URL: http://quiz-service:7302
      ENV: ${ENV:-PROD}
      IMAGE_UPLOAD_URL: ${CLASS_IMAGE_UPLOAD_URL}
      QUIZ_WEBHOOK_SECRET: ${QUIZ_WEBHOOK_SECRET}
      OUTBOX_PUBLISH_INTERVAL_MS: ${OUTBOX_PUBLISH_INTERVAL_MS}
      OUTBOX_BATCH_SIZE: ${OUTBOX_BATCH_SIZE}
      KAFKA_CLIENT_ID: ${CLASS_KAFKA_CLIENT_ID:-class-service}
      KAFKA_BROKERS: redpanda:9092
      KAFKA_GROUP: ${CLASS_KAFKA_GROUP:-class-svc.v1}
    ports:
      - "7303:7303"
    volumes:
      - /srv/quizapp/uploads/class:/app/uploads
    depends_on: [mongo-class, redpanda]

  class-worker:
    image: ${REGISTRY:-delishad21}/class-service:${IMAGE_TAG:-latest}
    command: npm run start:worker
    environment:
      NODE_ENV: production
      CLASS_MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME:-root}:${MONGO_ROOT_PASSWORD:-rootpassword}@mongo-class:27017/class?replicaSet=rs0&authSource=admin&retryWrites=true&w=majority
      KAFKA_CLIENT_ID: ${CLASS_KAFKA_CLIENT_ID:-class-service}
      KAFKA_BROKERS: redpanda:9092
      KAFKA_GROUP: ${CLASS_KAFKA_GROUP:-class-svc.v1}
    depends_on: [mongo-class, redpanda]

  quiz-service:
    image: ${REGISTRY:-delishad21}/quiz-service:${IMAGE_TAG:-latest}
    environment:
      NODE_ENV: production
      QUIZ_PORT: ${QUIZ_PORT:-7302}
      QUIZ_MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME:-root}:${MONGO_ROOT_PASSWORD:-rootpassword}@mongo-quiz:27017/quiz?replicaSet=rs0&authSource=admin&retryWrites=true&w=majority
      USER_SVC_URL: http://user-service:7301
      CLASS_SVC_URL: http://class-service:7303
      ENV: ${ENV:-PROD}
      IMAGE_UPLOAD_URL: ${QUIZ_IMAGE_UPLOAD_URL}
      QUIZ_WEBHOOK_SECRET: ${QUIZ_WEBHOOK_SECRET}
      OUTBOX_PUBLISH_INTERVAL_MS: ${OUTBOX_PUBLISH_INTERVAL_MS}
      OUTBOX_BATCH_SIZE: ${OUTBOX_BATCH_SIZE}
      KAFKA_CLIENT_ID: ${QUIZ_KAFKA_CLIENT_ID:-quiz-service}
      KAFKA_BROKERS: redpanda:9092
      KAFKA_GROUP: ${QUIZ_KAFKA_GROUP:-quiz-svc.v1}
      ATTEMPT_REDIS_URL: redis://default:${REDIS_PASSWORD:-supersecret_please_change}@redis:6379/0
    ports:
      - "7302:7302"
    volumes:
      - /srv/quizapp/uploads/quiz:/app/uploads
    depends_on: [mongo-quiz, redpanda, redis]

  quiz-worker:
    image: ${REGISTRY:-delishad21}/quiz-service:${IMAGE_TAG:-latest}
    command: npm run start:worker
    environment:
      NODE_ENV: production
      QUIZ_MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME:-root}:${MONGO_ROOT_PASSWORD:-rootpassword}@mongo-quiz:27017/quiz?replicaSet=rs0&authSource=admin&retryWrites=true&w=majority
      KAFKA_CLIENT_ID: ${QUIZ_KAFKA_CLIENT_ID:-quiz-service}
      KAFKA_BROKERS: redpanda:9092
      KAFKA_GROUP: ${QUIZ_KAFKA_GROUP:-quiz-svc.v1}
      ATTEMPT_REDIS_URL: redis://default:${REDIS_PASSWORD:-supersecret_please_change}@redis:6379/0
    depends_on: [mongo-quiz, redpanda, redis]

  user-service:
    image: ${REGISTRY:-delishad21}/user-service:${IMAGE_TAG:-latest}
    environment:
      NODE_ENV: production
      USER_PORT: ${USER_PORT:-7301}
      USER_MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME:-root}:${MONGO_ROOT_PASSWORD:-rootpassword}@mongo-user:27017/user?replicaSet=rs0&authSource=admin&retryWrites=true&w=majority
      ENV: ${ENV:-PROD}
      JWT_SECRET: ${JWT_SECRET:-dev-secret}
      GMAIL_USER: ${GMAIL_USER}
      GMAIL_PASS: ${GMAIL_PASS}
      GMAIL_NAME: ${GMAIL_NAME}
      APP_NAME: ${APP_NAME}
      FRONTEND_URL: ${FRONTEND_URL}
    ports:
      - "7301:7301"
    depends_on: [mongo-user]


  ai-service:
    image: ${REGISTRY:-delishad21}/ai-service:${IMAGE_TAG:-latest}
    environment:
      NODE_ENV: production
      AI_PORT: ${AI_PORT:-7304}
      AI_MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME:-root}:${MONGO_ROOT_PASSWORD:-rootpassword}@mongo-ai:27017/ai?replicaSet=rs0&authSource=admin&retryWrites=true&w=majority
      QUIZ_SVC_URL: http://quiz-service:7302
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
      JWT_SECRET: ${JWT_SECRET:-dev-secret}
    ports:
      - "7304:7304"
    volumes:
      - /srv/quizapp/uploads/ai:/app/uploads
    depends_on: [mongo-ai, quiz-service]
  web-app:
    image: ${REGISTRY:-delishad21}/web-app:${IMAGE_TAG:-latest}
    environment:
      NODE_ENV: production
      JWT_SECRET: ${JWT_SECRET:-dev-secret}
      USER_SVC_URL: ${NEXT_USER_URL}
      QUIZ_SVC_URL: ${NEXT_QUIZ_URL}
      CLASS_SVC_URL: ${NEXT_CLASS_URL}
      AI_SVC_URL: ${NEXT_AI_URL}
    ports:
      - "3002:3000"
    depends_on: [user-service]

  phone-frame:
    image: ${REGISTRY:-delishad21}/phone-frame:${IMAGE_TAG:-latest}
    ports:
      - "8088:8080"
    depends_on: [web-app]

  phone-web-app:
    image: ${REGISTRY:-delishad21}/phone-web-app:${IMAGE_TAG:-latest}
    ports:
      - "8089:8080"
    depends_on: [web-app]

volumes:
  {}
